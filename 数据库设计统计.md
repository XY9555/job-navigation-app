# 数据库设计代码统计

## 📊 总体统计

```
数据库设计总计: 329 行

├── 数据库配置: 103 行 (31.3%)
│   ├── database.js: 50 行
│   └── database-cloud.js: 53 行
│
└── 数据模型: 226 行 (68.7%)
    ├── User.js: 94 行
    ├── Resume.js: 112 行
    └── index.js: 20 行
```

---

## 🗄️ 数据库配置 (103行)

### 1. database.js (50行)
**功能**: SQLite 数据库配置（开发环境）

```javascript
// 主要内容
- Sequelize 连接配置
- SQLite 文件路径设置
- 连接测试函数
- 数据库同步函数
- 日志配置
```

**代码结构**:
- 配置定义: ~20行
- 连接测试: ~15行
- 同步函数: ~15行

### 2. database-cloud.js (53行)
**功能**: 云端数据库配置（生产环境）

```javascript
// 主要内容
- PostgreSQL 连接配置
- 环境判断逻辑
- SSL 配置
- 连接测试函数
- 数据库同步函数
```

**代码结构**:
- 环境判断: ~15行
- PostgreSQL 配置: ~20行
- 测试和同步: ~18行

---

## 📋 数据模型 (226行)

### 1. User.js (94行)
**功能**: 用户数据模型

#### 字段设计 (约50行)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| phone | STRING(20) | 手机号，唯一 |
| password | STRING(255) | 密码（加密） |
| name | STRING(50) | 姓名 |
| email | STRING(100) | 邮箱 |
| avatar | TEXT | 头像 |
| gender | ENUM | 性别 |
| age | INTEGER | 年龄 |
| settings | JSON | 用户设置 |

#### 业务逻辑 (约44行)
- **密码加密钩子** (~20行):
  - beforeCreate: 创建时加密
  - beforeUpdate: 更新时加密
  
- **实例方法** (~15行):
  - comparePassword: 密码验证
  - toJSON: 隐藏敏感信息
  
- **索引配置** (~9行):
  - phone 唯一索引

### 2. Resume.js (112行)
**功能**: 简历数据模型

#### 字段设计 (约85行)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| userId | INTEGER | 用户ID，外键 |
| title | STRING(100) | 简历标题 |
| personalInfo | JSON | 个人信息 |
| jobIntention | JSON | 求职意向 |
| education | JSON | 教育经历 |
| workExperience | JSON | 工作经历 |
| skills | JSON | 技能列表 |
| projects | JSON | 项目经历 |
| certificates | JSON | 证书列表 |
| selfEvaluation | TEXT | 自我评价 |
| evaluation | JSON | AI评测结果 |
| jobMatching | JSON | 职位匹配结果 |
| sourceInfo | JSON | 来源信息 |
| type | ENUM | 简历类型 |
| status | ENUM | 简历状态 |
| isDefault | BOOLEAN | 是否默认 |

#### 业务逻辑 (约27行)
- **关联关系** (~10行):
  - belongsTo User
  
- **索引配置** (~12行):
  - userId 索引
  - status 索引
  
- **表配置** (~5行):
  - 表名设置
  - 时间戳

### 3. index.js (20行)
**功能**: 模型导出和关联

```javascript
// 主要内容
- 导入所有模型
- 建立模型关联关系
- 统一导出
```

---

## 📊 数据库设计详细分析

### 表结构设计

#### users 表
```sql
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  phone VARCHAR(20) UNIQUE NOT NULL,
  password VARCHAR(255) NOT NULL,
  name VARCHAR(50) NOT NULL,
  email VARCHAR(100),
  avatar TEXT,
  gender ENUM('男', '女', '其他'),
  age INTEGER,
  settings JSON,
  createdAt DATETIME,
  updatedAt DATETIME
);

CREATE UNIQUE INDEX idx_users_phone ON users(phone);
```

**字段数**: 11 个
**索引数**: 1 个（phone 唯一索引）
**约束**: 
- phone 唯一且非空
- password 非空，长度 6-255
- name 非空，长度 1-50
- email 格式验证
- age 范围 16-100

#### resumes 表
```sql
CREATE TABLE resumes (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  userId INTEGER NOT NULL,
  title VARCHAR(100) NOT NULL,
  personalInfo JSON,
  jobIntention JSON,
  education JSON,
  workExperience JSON,
  skills JSON,
  projects JSON,
  certificates JSON,
  selfEvaluation TEXT,
  evaluation JSON,
  jobMatching JSON,
  sourceInfo JSON,
  type ENUM('normal', 'evaluation_result', 'matching_result'),
  status ENUM('draft', 'published', 'archived'),
  isDefault BOOLEAN DEFAULT FALSE,
  createdAt DATETIME,
  updatedAt DATETIME,
  FOREIGN KEY (userId) REFERENCES users(id)
);

CREATE INDEX idx_resumes_userId ON resumes(userId);
CREATE INDEX idx_resumes_status ON resumes(status);
```

**字段数**: 19 个
**索引数**: 2 个（userId, status）
**外键**: 1 个（userId → users.id）
**约束**:
- userId 非空，外键关联
- title 非空，长度 1-100
- type 枚举值
- status 枚举值

### 关联关系

```
User (1) ←→ (N) Resume
一个用户可以有多个简历
一个简历属于一个用户
```

---

## 💡 数据库设计特点

### 1. 灵活的JSON字段设计

**优点**:
- 适应复杂的简历结构
- 无需频繁修改表结构
- 支持动态字段

**使用JSON的字段**:
- personalInfo: 个人信息（姓名、性别、年龄等）
- jobIntention: 求职意向（期望职位、薪资等）
- education: 教育经历数组
- workExperience: 工作经历数组
- skills: 技能列表
- projects: 项目经历数组
- evaluation: AI评测结果
- jobMatching: 职位匹配结果

### 2. 完善的数据验证

**字段级验证**:
- 长度验证 (len)
- 格式验证 (isEmail, isNumeric)
- 范围验证 (min, max)
- 唯一性验证 (unique)

**业务级验证**:
- 密码自动加密
- 敏感信息隐藏
- 外键约束

### 3. 合理的索引设计

**索引策略**:
- 主键索引: id (自动)
- 唯一索引: phone (查询优化)
- 普通索引: userId, status (查询优化)

### 4. 支持多环境部署

**开发环境**: SQLite
- 轻量级
- 零配置
- 文件存储

**生产环境**: PostgreSQL
- 高性能
- 云端部署
- 数据安全

---

## 📈 代码量占比

### 在独立编写代码中的占比

```
独立编写代码总量: 14,721 行

数据库设计: 329 行 (2.2%)
├── 配置: 103 行 (0.7%)
└── 模型: 226 行 (1.5%)
```

### 在后端代码中的占比

```
后端代码总量: 4,159 行

数据库设计: 329 行 (7.9%)
├── 配置: 103 行 (2.5%)
└── 模型: 226 行 (5.4%)
```

---

## 🎯 数据库设计价值

### 核心价值

1. **数据结构定义** (226行):
   - 2个核心数据模型
   - 30个字段定义
   - 完整的验证规则

2. **业务逻辑封装** (约60行):
   - 密码加密
   - 数据验证
   - 关联关系

3. **多环境支持** (103行):
   - 开发环境配置
   - 生产环境配置
   - 自动切换

### 设计质量

- ✅ 字段设计合理
- ✅ 索引配置优化
- ✅ 验证规则完善
- ✅ 关联关系清晰
- ✅ 支持多环境部署

---

## ✅ 总结

### 数据库设计统计

```
数据库设计代码: 329 行

配置层: 103 行
├── SQLite配置: 50 行
└── PostgreSQL配置: 53 行

模型层: 226 行
├── User模型: 94 行
├── Resume模型: 112 行
└── 模型关联: 20 行
```

### 设计特点

- **精简高效**: 329行代码实现完整的数据库设计
- **灵活扩展**: JSON字段支持复杂数据结构
- **安全可靠**: 完善的验证和加密机制
- **多环境**: 支持SQLite和PostgreSQL

---

**统计日期**: 2024年11月
**数据库类型**: SQLite (开发) / PostgreSQL (生产)
**ORM框架**: Sequelize
**代码总量**: 329 行
